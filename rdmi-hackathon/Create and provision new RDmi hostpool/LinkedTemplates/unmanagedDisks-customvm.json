{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "rdshPrefix": {
            "type": "string",
            "metadata": {
                "description": "This prefix will be used in combination with the VM number to create the VM name. This value includes the dash, so if using “rdsh” as the prefix, VMs would be named “rdsh-0”, “rdsh-1”, etc. You should use a unique prefix to reduce name collisions in Active Directory."
            },
            "defaultValue": "[take(toLower(resourceGroup().name),10)]"
        },
        "rdshNumberOfInstances": {
            "type": "int",
            "metadata": {
                "description": "Number of session hosts that will be created and added to the hostpool."
            }
        },
        "rdshVmSize": {
            "type": "string",
            "metadata": {
                "description": "The size of the session host VMs."
            },
            "defaultValue": "Standard_A2"
        },
        "rdshVMDiskType": {
            "type": "string",
            "allowedValues": [
                "SSD",
                "HDD"
            ],
            "metadata": {
                "description": "The VM disk type for the VM: HDD or SSD."
            },
            "defaultValue": "SSD"
        },
        "existingDomainusername": {
            "type": "string",
            "metadata": {
                "description": "The username for the admin."
            }
        },
        "existingDomainPassword": {
            "type": "securestring",
            "metadata": {
                "description": "The password that corresponds to the existing domain username."
            }
        },
        "VmImageVhdUri": {
            "type": "string",
            "metadata": {
                "description": "URI of the sysprepped image vhd file to be used to create the session host VMs. For example, https://rdsstorage.blob.core.windows.net/vhds/sessionhostimage.vhd"
            }
        },
        "storageaccount": {
            "type": "string",
            "metadata": {
                "description": "The storage account containing the custom VHD."
            }
        }
    },
    "variables": {},
    "resources": [
        {
            "apiVersion": "2018-06-01",
            "type": "Microsoft.Compute/virtualMachines",
            "name": "[concat(parameters('rdshPrefix'), copyindex())]",
            "location": "[resourceGroup().location]",
            "copy": {
                "name": "rdsh-vm-loop",
                "count": "[parameters('rdshNumberOfInstances')]"
            },
            "properties": {
                "hardwareProfile": {
                    "vmSize": "[parameters('rdshVmSize')]"
                },
                "availabilitySet": {
                    "id": "[resourceId('Microsoft.Compute/availabilitySets/', concat(parameters('rdshPrefix'), 'availabilitySet'))]"
                },
                "osProfile": {
                    "computerName": "[concat(parameters('rdshPrefix'), copyindex())]",
                    "adminUsername": "[parameters('existingDomainUsername')]",
                    "adminPassword": "[parameters('existingDomainPassword')]"
                },
                "storageProfile": {
                    "osDisk": {
                        "name": "[concat(parameters('rdshPrefix'), copyindex(),'-osDisk')]",
                        "osType": "Windows",
                        "caching": "ReadWrite",
                        "createOption": "FromImage",
                        "image": {
                            "uri": "[parameters('VmImageVhdUri')]"
                        },
                        "vhd": {
                            "uri": "[concat(reference(parameters('storageaccount'), '2016-01-01').primaryEndpoints.blob, variables('vhds'), copyindex(), '-osdisk.vhd')]"
                        }
                    }
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces',concat(parameters('rdshPrefix'), copyindex(), '-nic'))]"
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": "[equals(parameters('rdshVMDiskType'), 'HDD')]",
                        "storageUri": "[reference(parameters('storageaccount'), '2016-01-01').primaryEndpoints.blob]"
                    }
                }
            }
        }
    ]
}